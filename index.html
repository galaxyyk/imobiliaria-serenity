<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Serenity Imobiliária - Catálogo de Imóveis</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }

    body {
      min-height: 100vh;
      background-color: #3a7a76;
      padding: 2rem;
      color: #333333;
      display: flex;
      justify-content: center;
    }

    .container {
      max-width: 1200px;
      width: 100%;
      background-color: #d6c7b4;
      border-radius: 10px;
      padding: 2rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: row;
      gap: 2rem;
    }

    .main-content {
      flex: 1;
      min-width: 0; /* Prevent flex item overflow */
    }

    .sidebar {
      width: 250px;
      flex-shrink: 0; /* Prevent sidebar from shrinking */
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #dbae8e;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .logo-circle {
      width: 40px;
      height: 40px;
      background-color: #dbae8e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333333;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .header-buttons {
      display: flex;
      gap: 1rem;
    }

    .logout-btn {
      background-color: #3a7a76;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .logout-btn:hover {
      background-color: #2e605d;
    }

    .search-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .search-input {
      width: 100%;
      padding: 0.8rem 1rem;
      border: 1px solid #dbae8e;
      border-radius: 8px;
      font-size: 1rem;
    }

    .search-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .search-btn {
      background-color: #dbae8e;
      color: #333333;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .search-btn.active {
      background-color: #3a7a76;
      color: white;
    }

    .search-btn:hover {
      opacity: 0.9;
    }

    .data-table-container { /* Added container for responsiveness */
       width: 100%;
       overflow-x: auto; /* Allow horizontal scrolling on small screens */
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      background-color: white;
      border-radius: 8px;
      overflow: hidden; /* Needed with border-radius */
    }

    .data-table th, .data-table td {
      padding: 0.8rem 1rem;
      text-align: left;
      border-bottom: 1px solid #d6c7b4;
      white-space: nowrap; /* Prevent text wrapping */
    }

    .data-table th {
      background-color: #3a7a76;
      color: white;
      position: sticky; /* Keep header visible when scrolling vertically */
      top: 0;          /* Required for sticky */
      z-index: 1;      /* Ensure header stays above table content */
    }

    .data-table tr:last-child td { /* Remove border from last row */
        border-bottom: none;
    }


    .data-table tr:hover {
      background-color: rgba(219, 174, 142, 0.1);
    }

    .no-data {
      text-align: center;
      padding: 2rem;
      color: #666;
    }

    .status-message {
      margin-top: 1rem;
      padding: 0.8rem;
      border-radius: 4px;
      display: flex; /* Align items */
      align-items: center; /* Vertically center items */
      gap: 0.5rem; /* Space between indicator and text */
    }

    .status-message.success {
      background-color: #d4edda;
      color: #155724;
    }

    .status-message.error {
      background-color: #f8d7da;
      color: #721c24;
    }

    .status-message.loading { /* Add styling for loading state */
        background-color: #e2e3e5;
        color: #383d41;
    }

    .loading-indicator { /* Renamed from .loading to be more specific */
      display: inline-block;
      width: 16px; /* Slightly smaller */
      height: 16px;
      border: 3px solid rgba(0,0,0,.1); /* Lighter base */
      border-radius: 50%;
      border-top-color: #3a7a76; /* Use theme color */
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .sidebar h4 {
      margin-bottom: 1rem;
      color: #333;
    }

    .building-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      max-height: calc(100vh - 200px); /* Example max height */
      overflow-y: auto; /* Add scroll if list is long */
      padding-right: 5px; /* Add some space for scrollbar */
    }

    .building-item {
      background-color: #3a7a76;
      color: white;
      padding: 0.5rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .building-item:hover {
      background-color: #2e605d;
    }

    /* Responsive adjustments */
    @media (max-width: 992px) { /* Adjust breakpoint as needed */
        .container {
            flex-direction: column;
        }
        .sidebar {
            width: 100%;
            order: -1; /* Move sidebar above main content on smaller screens */
            margin-bottom: 2rem;
            max-height: 300px; /* Adjust height for horizontal layout */
        }
        .building-list{
            max-height: 200px; /* Adjust scroll height */
        }
    }

     @media (max-width: 768px) {
        body {
            padding: 1rem; /* Reduce padding on smaller screens */
        }
        .container {
            padding: 1rem;
        }
        .header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        .search-buttons {
            gap: 0.5rem; /* Reduce gap between buttons */
        }
        .search-btn {
             padding: 0.5rem 0.8rem; /* Smaller buttons */
             font-size: 0.8rem;
        }
        .logout-btn {
            padding: 0.4rem 0.8rem;
             font-size: 0.8rem;
        }
        .data-table th, .data-table td {
            padding: 0.6rem 0.8rem; /* Reduce cell padding */
        }
     }

  </style>
</head>
<body>
  <div class="container">

     <div class="sidebar">
        <h4>Prédios Completos</h4>
        <div class="building-list" id="buildingList">
            <p style="color: #666; font-size: 0.9rem;">Carregando prédios...</p>
        </div>
     </div>

    <div class="main-content">
      <div class="header">
        <div class="logo">
          <div class="logo-circle">S</div>
          <span>Serenity Imobiliária</span>
        </div>
        <div class="header-buttons">
          <button class="logout-btn" onclick="location.href='captacao.html'">Captação</button>
          <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
      </div>

      <div class="search-section">
        <h3>Buscar Imóveis</h3>
        <input type="text" class="search-input" id="searchInput" placeholder="Digite sua busca...">
        <div class="search-buttons">
          <button class="search-btn active" data-type="all">Todos</button>
          <button class="search-btn" data-type="address">Busca por Endereço</button>
          <button class="search-btn" data-type="building">Busca por Prédio</button>
          <button class="search-btn" data-type="inscription">Busca por Inscrição</button>
        </div>
        <label style="margin-top: 1rem; display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="checkbox" id="showAllToggle">
          Mostrar todos os imóveis (pode levar mais tempo)
        </label>
        <div class="status-message loading" id="statusMessage"> <span id="loadingIndicator" class="loading-indicator"></span>
          <span id="statusText">Carregando catálogo de imóveis...</span>
        </div>
      </div>

      <div class="data-table-container"> <table class="data-table" id="dataTable">
          <thead>
            <tr>
              <th>Endereço</th>
              <th>Prédio</th>
              <th>Complemento</th>
              <th>Inscrição</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="4" class="no-data">Carregando imóveis...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script>
    const firebaseConfig = {
      // IMPORTANT: Replace with your actual Firebase config
      apiKey: "AIzaSyDGSLzvob9IS9LWUsR4i0FVuW7k5_wcjgA",
      authDomain: "serenity-imobiliaria.firebaseapp.com",
      projectId: "serenity-imobiliaria",
      storageBucket: "serenity-imobiliaria.appspot.com",
      messagingSenderId: "381579749133",
      appId: "1:381579749133:web:ccbad8bc904b1d35853244",
      measurementId: "G-K3NGJMBYKH"
    };
    firebase.initializeApp(firebaseConfig);

    // Auth state listener
    firebase.auth().onAuthStateChanged(user => {
      // Redirect to login if not authenticated
      if (!user) {
        console.log("Usuário não autenticado, redirecionando para login.html");
        // window.location.href = "login.html"; // Uncomment this line to enable redirection
      } else {
        console.log("Usuário autenticado:", user.email);
      }
    });

    // Logout function
    function logout() {
       console.log("Tentando fazer logout...");
      firebase.auth().signOut().then(() => {
        console.log("Logout bem-sucedido, redirecionando...");
        window.location.href = "login.html";
      }).catch((error) => {
         console.error("Erro no logout:", error);
         alert("Erro ao tentar sair. Verifique o console para detalhes.");
      });
    }
  </script>

  <script>
    // DOM Elements
    const searchInput = document.getElementById('searchInput');
    const searchButtons = document.querySelectorAll('.search-btn');
    const tableBody = document.getElementById('tableBody');
    const statusMessage = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const buildingList = document.getElementById('buildingList');
    const showAllToggle = document.getElementById('showAllToggle');

    // === CONFIGURATION ===
    const JSON_URL = 'imoveis.json';
    const INITIAL_ROW_LIMIT = 100; // How many rows to show initially

    // Global state
    let allProperties = []; // Holds all data from JSON
    let currentData = [];   // Holds currently filtered/displayed data
    let validBuildings = []; // Holds unique building names for the sidebar
    let currentSearchType = 'all'; // Default search type

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
      // Set initial search type based on the active button
      const activeButton = document.querySelector('.search-btn.active');
      if (activeButton) {
        currentSearchType = activeButton.dataset.type;
      }
      loadPropertyData(); // Load data when the page is ready
    });

    // --- Data Loading ---
    async function loadPropertyData() {
      updateStatus('Carregando catálogo de imóveis...', 'loading', true); // Show loading indicator
      try {
        const response = await fetch(JSON_URL);
        if (!response.ok) {
          // Provide more specific error messages
          if (response.status === 404) {
             throw new Error(`Arquivo não encontrado (${JSON_URL}). Verifique o nome e o local do arquivo.`);
          } else {
             throw new Error(`Falha ao carregar dados (Status: ${response.status})`);
          }
        }
        allProperties = await response.json();

        // Basic data validation (check if it's an array)
        if (!Array.isArray(allProperties)) {
            throw new Error("O arquivo JSON não contém um array válido.");
        }

        console.log(`Loaded ${allProperties.length} properties initially.`);

        // Populate the building list for the sidebar
        populateValidBuildings();
        renderBuildingList();

        // Initial filter and display
        filterData(); // Apply initial filter (shows limited data)

        updateStatus(`Catálogo carregado com ${allProperties.length} imóveis.`, 'success');

      } catch (error) {
        console.error('Erro detalhado ao carregar dados:', error);
        updateStatus(`Erro: ${error.message}`, 'error');
        tableBody.innerHTML = `<tr><td colspan="4" class="no-data">Erro ao carregar dados. Verifique o console (F12) para mais detalhes.</td></tr>`;
        buildingList.innerHTML = `<p style="color: #721c24; font-size: 0.9rem;">Erro ao carregar prédios.</p>`; // Update sidebar on error
      }
    }

    // --- Sidebar Building List ---
    function populateValidBuildings() {
        // Use Set for efficient unique value extraction
        const buildingNames = new Set(
             allProperties
                .map(item => item && item.building ? item.building.trim() : null) // Get building names, trim whitespace
                .filter(name => name) // Filter out null/empty names
        );
        validBuildings = [...buildingNames].sort((a, b) => a.localeCompare(b)); // Convert Set to sorted array
        console.log(`Found ${validBuildings.length} unique buildings.`);
    }

    function renderBuildingList() {
      buildingList.innerHTML = ''; // Clear previous list
      if (validBuildings.length === 0) {
          buildingList.innerHTML = `<p style="color: #666; font-size: 0.9rem;">Nenhum prédio encontrado.</p>`;
          return;
      }

      validBuildings.forEach(building => {
        const div = document.createElement('div');
        div.className = 'building-item';
        div.textContent = building;
        div.title = building; // Show full name on hover if truncated
        div.addEventListener('click', () => {
          // Set search type to 'building' and trigger filter
          currentSearchType = 'building';
          searchInput.value = building; // Populate search bar with building name
          // Update active button visual state
          searchButtons.forEach(btn => btn.classList.remove('active'));
          document.querySelector(`.search-btn[data-type="building"]`).classList.add('active');
          filterData(); // Apply the filter
        });
        buildingList.appendChild(div);
      });
    }

    // --- Status Updates ---
    function updateStatus(message, type, isLoading = false) {
       if (!statusMessage || !statusText || !loadingIndicator) return; // Guard against missing elements

      statusText.textContent = message;
      // Reset classes and apply the correct type
      statusMessage.className = 'status-message ' + type;
      // Show/hide loading indicator
      loadingIndicator.style.display = isLoading ? 'inline-block' : 'none';
    }

    // --- Event Listeners ---
    searchInput.addEventListener('input', () => {
      // Optional: Add debounce here if needed for very large datasets
      filterData();
    });

    showAllToggle.addEventListener('change', () => {
      filterData();
    });

    searchButtons.forEach(button => {
      button.addEventListener('click', function () {
        searchButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        currentSearchType = this.dataset.type;
        filterData();
      });
    });

    // --- Data Filtering ---
    function filterData() {
       if (!allProperties) return; // Don't filter if data hasn't loaded

      const searchTerm = searchInput.value.trim().toLowerCase();

      // Filter the main properties array
      currentData = allProperties.filter(item => {
        // Ensure item is a valid object before accessing properties
        if (!item || typeof item !== 'object') {
            // console.warn("Skipping invalid item in JSON data:", item);
            return false;
        }

        // Get values safely, converting to lowercase
        const address = (item.address || '').toLowerCase();
        const building = (item.building || '').toLowerCase();
        const complement = (item.complement || '').toLowerCase(); // Included for 'all' search
        // *** THIS IS THE CORRECTED LINE: ***
        const inscription = String(item.inscription || '').toLowerCase(); // Force conversion to string

        // Apply filter based on current search type
        switch (currentSearchType) {
          case 'address': return address.includes(searchTerm);
          case 'building': return building.includes(searchTerm);
          case 'inscription': return inscription.includes(searchTerm);
          // Note: No dedicated 'complement' button, but it's included in 'all'
          case 'all':
          default:
            return (
              address.includes(searchTerm) ||
              building.includes(searchTerm) ||
              complement.includes(searchTerm) || // Complement is searched in 'all'
              inscription.includes(searchTerm)
            );
        }
      });

      // Update the displayed table
      displayData(currentData);
    }

    // --- Data Display ---
    function displayData(data) {
        if (!tableBody) return; // Guard

      const searchTerm = searchInput.value.trim(); // Get current search term for limit logic
      const shouldLimit = !showAllToggle.checked && !searchTerm; // Limit only if checkbox is off AND search is empty
      const dataToDisplay = shouldLimit ? data.slice(0, INITIAL_ROW_LIMIT) : data;

      // Clear previous table content
      tableBody.innerHTML = '';

      if (data.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="no-data">Nenhum imóvel encontrado para a busca atual.</td></tr>`;
        updateStatus(`Nenhum imóvel encontrado (${data.length} resultados).`, 'success'); // Update status for no results
        return;
      }

      if (dataToDisplay.length === 0 && data.length > 0) {
         // This case shouldn't typically happen with current logic, but good to handle
         tableBody.innerHTML = `<tr><td colspan="4" class="no-data">Nenhum imóvel para exibir (verifique limite inicial).</td></tr>`;
         return;
      }

      // Populate table rows
      dataToDisplay.forEach(item => {
         // Double-check item validity
        if (!item || typeof item !== 'object') return;

        const row = document.createElement('tr');
        // Use textContent for security (prevents HTML injection if data contains markup)
        const addressCell = document.createElement('td');
        addressCell.textContent = item.address || '-';
        const buildingCell = document.createElement('td');
        buildingCell.textContent = item.building || '-';
        const complementCell = document.createElement('td');
        complementCell.textContent = item.complement || '-';
        const inscriptionCell = document.createElement('td');
        // Also ensure inscription is displayed as a string
        inscriptionCell.textContent = String(item.inscription || '-');

        row.appendChild(addressCell);
        row.appendChild(buildingCell);
        row.appendChild(complementCell);
        row.appendChild(inscriptionCell);

        tableBody.appendChild(row);
      });

       // Update status message based on displayed results
       if (shouldLimit && data.length > INITIAL_ROW_LIMIT) {
           updateStatus(`Exibindo ${dataToDisplay.length} de ${data.length} imóveis. Marque "Mostrar todos" ou refine a busca para ver mais.`, 'success');
       } else {
           updateStatus(`${data.length} imóveis encontrados.`, 'success');
       }
    }

  </script>
</body>
</html>
